<template>
  <div>
    <!-- ËøõÂ∫¶Ê†è -->
    <div class="steps-container">
      <a-steps :current="current">
        <a-step title="Â°´ÂÜôËµÑÊñô‰ø°ÊÅØ" />
        <a-step title="Á°ÆËÆ§ËµÑÊñô‰ø°ÊÅØ" />
        <a-step title="ÂÆåÊàê" />
      </a-steps>
    </div>

    <!-- ÊèêÁ§∫Ê°Ü -->
    <div class="info-box" v-if="infoVisible">
      <span class="icon">üîî</span>
      ËµÑÊñô‰∏ä‰º†ÊàêÂäüÂêéÂèØÂú®Êï∞ÊçÆÊü•ËØ¢È°µÈù¢Êü•Áúã
      <el-button class="close-button" @click="hideInfo" type="text">√ó</el-button>
    </div>

    <!-- Â°´ÂÜôËµÑÊñô‰ø°ÊÅØÈ°µÈù¢ -->
    <div v-if="current === 0" class="form-container">
      <!-- ÈÄâÊã©ÁõëÊµãÁ±ªÂûãÔºåËßÇÊµãÂú∞ÁÇπÔºåÂíåËßÇÊµãÊó•ÊúüÂú®‰∏ÄË°å -->
      <el-row :gutter="20" style="margin-bottom: 18px; width: 100%">
        <el-col :span="8">
          <el-form-item label="ÁõëÊµãÁ±ªÂûãÔºö" label-width="120px">
            <el-select v-model="submitType" placeholder="ËØ∑ÈÄâÊã©ÁõëÊµãÁ±ªÂûã" style="width: 100%">
              <el-option label="ÊπøÂú∞ÂúüÂ£§Ê£ÄÊµãÊåáÊ†á" value="soil"></el-option>
              <el-option label="ÊπøÂú∞Ê§çË¢´Ê£ÄÊµãÊåáÊ†á" value="plant"></el-option>
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="ËßÇÊµãÂú∞ÁÇπÔºö" label-width="120px">
            <el-select v-model="deviceName" placeholder="ËØ∑ÈÄâÊã©ËßÇÊµãÂú∞ÁÇπ" style="width: 100%">
              <el-option v-for="item in locations" :key="item.id" :label="item.deviceName" :value="item.id"></el-option>
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="ËßÇÊµãÊó•ÊúüÔºö" label-width="120px" :required="true">
            <el-date-picker v-model="investigationTime1" type="date" placeholder="ÈÄâÊã©Êó•Êúü" format="YYYY-MM-DD"
              value-format="YYYY-MM-DD" style="width: 100%">
            </el-date-picker>
          </el-form-item>
        </el-col>
      </el-row>

      <!-- ÂúüÂ£§ÁõëÊµãË°®Âçï -->
      <el-form v-if="submitType === 'soil'" :key="submitType" ref="soilFormRef" style="width: 100%; margin: 0"
        :model="soilForm" label-width="120px" class="demo-dynamic-soil">
        <div v-for="(group, index) in soilForm.groups" :key="group.key" style="
            border: 1px solid #ccc;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
          ">
          <h4>ÂúüÂ£§ÁõëÊµãÊåáÊ†áÁªÑÂà´{{ index + 1 }}</h4>

          <!-- ÂúüÂ£§Ê∑±Â∫¶ÂíåÂúüÂ£§Âê´Ê∞¥Èáè -->
          <el-row :gutter="20">
            <el-col :span="8">
              <el-form-item :label="'ÂúüÂ£§Ê∑±Â∫¶'" :prop="'groups.' + index + '.depthRange'" :required="true" :show-message="false">
                <el-input v-model="group.depthRange" placeholder="ËØ∑ËæìÂÖ•ÂúüÂ£§Ê∑±Â∫¶ËåÉÂõ¥" style="width: 100%"><template #append>cm</template></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="8">
              <el-form-item :label="'ÂúüÂ£§Âê´Ê∞¥Èáè '" :prop="'groups.' + index + '.soilMoistureContent'" :required="true" :show-message="false">
                <el-input v-model="group.soilMoistureContent" type="number" placeholder="ËØ∑ËæìÂÖ•ÂúüÂ£§Âê´Ê∞¥Èáè"
                  style="width: 100%"><template #append>%</template></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="8">
              <el-form-item :label="'ÂúüÂ£§ÊúâÊú∫Áâ©Âê´Èáè '" :prop="'groups.' + index + '.soilOrganicMatterContent'"
                :required="true" :show-message="false">
                <el-input v-model="group.soilOrganicMatterContent" type="number" placeholder="ËØ∑ËæìÂÖ•ÂúüÂ£§ÊúâÊú∫Áâ©Âê´Èáè"
                  style="width: 100%"><template #append>g/100g</template></el-input>
              </el-form-item>
            </el-col>
          </el-row>

          <!-- ÂúüÂ£§Âê´Á¢≥ÊÄªÈáèÂíåÂúüÂ£§Âê´Ê∞ÆÊÄªÈáè -->
          <el-row :gutter="20">
            <el-col :span="8">
              <el-form-item :label="'ÂúüÂ£§Âê´Á¢≥ÊÄªÈáè '" :prop="'groups.' + index + '.totalSoilCarbonContent'" :required="true" :show-message="false">
                <el-input v-model="group.totalSoilCarbonContent" type="number" placeholder="ËØ∑ËæìÂÖ•ÂúüÂ£§Âê´Á¢≥ÊÄªÈáè"
                  style="width: 100%"><template #append>g/100g</template></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="8">
              <el-form-item :label="'ÂúüÂ£§Âê´Ê∞ÆÊÄªÈáè '" :prop="'groups.' + index + '.totalSoilNitrogenContent'" :required="true" :show-message="false">
                <el-input v-model="group.totalSoilNitrogenContent" type="number" placeholder="ËØ∑ËæìÂÖ•ÂúüÂ£§Âê´Ê∞ÆÊÄªÈáè"
                  style="width: 100%"><template #append>g/100g</template></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="8">
              <el-form-item :label="'ÂúüÂ£§Âê´Á£∑ÊÄªÈáè '" :prop="'groups.' + index + '.totalSoilPhosphorusContent'"
                :required="true" :show-message="false">
                <el-input v-model="group.totalSoilPhosphorusContent" type="number" placeholder="ËØ∑ËæìÂÖ•ÂúüÂ£§Âê´Á£∑ÊÄªÈáè"
                  style="width: 100%"><template #append>g/100g</template></el-input>
              </el-form-item>
            </el-col>
          </el-row>

          <!-- ÊåâÈíÆÂùáÂåÄÂàÜÂ∏É -->
          <el-row :gutter="20" style="margin-top: 10px; text-align: center">
            <el-col :span="12">
              <el-button style="width: 25%" @click="addSoilGroup">
                Â¢ûÂä†ÂúüÂ£§ÁõëÊµãÊåáÊ†áÁªÑ
              </el-button>
            </el-col>
            <el-col :span="12">
              <el-button style="width: 25%" @click="removeSoilGroup(group)">
                Âà†Èô§ÂúüÂ£§ÁõëÊµãÊåáÊ†áÁªÑ
              </el-button>
            </el-col>
            <el-col :span="8">
              <!-- ÂèØÂä†ÂÖ•ÂÖ∂‰ªñÊåâÈíÆÊàñÂäüËÉΩ -->
            </el-col>
          </el-row>
        </div>
      </el-form>
      <!-- Ê§çË¢´Áõ∏ÂÖ≥Ë°®Âçï -->
      <el-form v-if="submitType === 'plant'" :key="submitType" model="form" label-width="120px"
        style="width: 100%; margin: 0">
        <div style="
            border: 1px solid #ccc;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
          ">
          <!-- Á¨¨‰∏ÄË°å: Ê§çË¢´Áâ©Áßç, Âè∂Èù¢ÁßØÊåáÊï∞, Áâ©ÂÄôÊåáÊï∞ -->
          <el-row :gutter="20" style="margin-bottom: 18px">
            <el-col :span="8">
              <el-form-item label="Ê§çË¢´Áâ©ÁßçÔºö" label-width="120px" :required="true">
                <el-select v-model="vegetationSpecies" @change="clearVegetationForm" placeholder="ËØ∑ÈÄâÊã©Ê§çË¢´Áâ©Áßç"
                  style="width: 98%">
                  <el-option v-for="species in vegetationSpeciesOptions" :key="species" :label="species"
                    :value="species"></el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="8">
              <el-form-item label="Âè∂Èù¢ÁßØÊåáÊï∞Ôºö" label-width="120px" :required="true">
                <el-input v-model="leafAreaIndex" type="number" placeholder="ËØ∑ËæìÂÖ•Âè∂Èù¢ÁßØÊåáÊï∞" style="width: 100%"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="8">
              <el-form-item label="Áâ©ÂÄôÊåáÊï∞Ôºö" label-width="120px" :required="true">
                <el-input v-model="phenologicalIndex" type="number" placeholder="ËØ∑ËæìÂÖ•Áâ©ÂÄôÊåáÊï∞"
                  style="width: 100%"></el-input>
              </el-form-item>
            </el-col>
          </el-row>

          <!-- Á¨¨‰∫åË°å: Ê§çË¢´Âê´Ê∞¥Èáè, Âè∂ÁªøÁ¥†Âê´Èáè, ÁîüÁâ©Èáè -->
          <el-row :gutter="20" style="margin-bottom: 18px">
            <el-col :span="8">
              <el-form-item label="Ê§çË¢´Âê´Ê∞¥ÈáèÔºö" label-width="120px" :required="true">
                <el-input v-model="vegetationMoistureContent" type="number" placeholder="ËØ∑ËæìÂÖ•Ê§çË¢´Âê´Ê∞¥Èáè"
                  style="width: 100%"><template #append>%</template></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="8">
              <el-form-item label="Âè∂ÁªøÁ¥†Âê´ÈáèÔºö" label-width="120px" :required="true">
                <el-input v-model="chlorophyllContent" type="number" placeholder="ËØ∑ËæìÂÖ•Âè∂ÁªøÁ¥†Âê´Èáè"
                  style="width: 100%"><template #append>mg/g</template></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="8">
              <el-form-item label="ÁîüÁâ©ÈáèÔºö" label-width="120px" :required="true">
                <el-input v-model="biomass" type="number" placeholder="ËØ∑ËæìÂÖ•ÁîüÁâ©Èáè" style="width: 100%"><template #append>g/m¬≤</template></el-input>
              </el-form-item>
            </el-col>
          </el-row>

          <!-- Á¨¨‰∏âË°å: Á¢≥Ê∞ÆÊØî -->
          <el-row :gutter="20" style="margin-bottom: 18px">
            <el-col :span="8">
              <el-form-item label="Á¢≥Ê∞ÆÊØîÔºö" label-width="120px" :required="true">
                <el-input v-model="carbonNitrogenRatio" type="number" placeholder="ËØ∑ËæìÂÖ•Á¢≥Ê∞ÆÊØî"
                  style="width: 100%"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </div>
      </el-form>
      <!-- ÂÖ¨ÂÖ±Ë°®Âçï -->
      <!-- <el-form :model="form" label-width="120px" style="width: 40%; margin: 0 auto;">
        <el-form-item label="Êï∞ÊçÆÁÆÄ‰ªãÔºö" :required="publishStatus === 'public'">
          <el-input type="textarea" v-model="dataDescription" placeholder="ËØ∑ËæìÂÖ•Êï∞ÊçÆÁÆÄ‰ªã" rows="4"></el-input>
        </el-form-item>
        <el-form-item label="ÂèëÂ∏É‰∫∫Ôºö" :required="publishStatus === 'public'">
          <el-input v-model="publisher" placeholder="ËØ∑ËæìÂÖ•ÂèëÂ∏É‰∫∫ÂßìÂêç"></el-input>
        </el-form-item>
        <el-form-item label="ËÅîÁ≥ªÁîµËØùÔºö" :required="publishStatus === 'public'">
          <el-input v-model="contactPhone" placeholder="ËØ∑ËæìÂÖ•ÂèëÂ∏É‰∫∫ËÅîÁ≥ªÁîµËØù"></el-input>
        </el-form-item>
        <el-form-item label="ËÅîÁ≥ªÂú∞ÂùÄÔºö" :required="publishStatus === 'public'">
          <el-input v-model="contactAddress" placeholder="ËØ∑ËæìÂÖ•ÂèëÂ∏É‰∫∫ËÅîÁ≥ªÂú∞ÂùÄ"></el-input>
        </el-form-item>
        <el-form-item label="ËÅîÁ≥ªÈÇÆÁÆ±Ôºö" :required="publishStatus === 'public'">
          <el-input v-model="contactEmail" placeholder="ËØ∑ËæìÂÖ•ÂèëÂ∏É‰∫∫ËÅîÁ≥ªÈÇÆÁÆ±"></el-input>
        </el-form-item>
        <el-form-item label="Âà∂‰ΩúÂçï‰ΩçÔºö" :required="publishStatus === 'public'">
          <el-input v-model="productionUnit" placeholder="ËØ∑ËæìÂÖ•Âà∂‰ΩúÂçï‰Ωç"></el-input>
        </el-form-item>
      </el-form> -->
      <div class="button-group">
        <el-button @click="handleCancel" class="cancel-button">ÂèñÊ∂à</el-button>
        <el-button @click="handleSubmit" class="submit-button" type="primary">Êèê‰∫§</el-button>
      </div>
    </div>

    <!-- Á°ÆËÆ§ËµÑÊñô‰ø°ÊÅØÈ°µÈù¢ -->
    <div v-if="current === 1" class="form-container">
      <el-table :data="infoData" style="width: 50%; margin: 0 auto" border="true"
        :header-cell-style="{ backgroundColor: '#f2f2f2' }">
        <el-table-column prop="title" label="‰ø°ÊÅØÈ°π" width="150"></el-table-column>
        <el-table-column prop="value" label="ÂÜÖÂÆπ"></el-table-column>
      </el-table>
      <div class="button-group">
        <el-button @click="handlePrevious" class="cancel-button">‰∏ä‰∏ÄÊ≠•</el-button>
        <el-button @click="handleConfirm" class="submit-button" type="primary">Á°ÆËÆ§</el-button>
      </div>
    </div>

    <!-- ÂÆåÊàêÈ°µÈù¢ -->
    <div v-if="current === 2" class="form-container">
      <div class="completion-icon"></div>
      <h1 class="form-title">‰∏ä‰º†ÂÆåÊàê</h1>
      <div class="button-group">
        <el-button @click="handleContinue" class="submit-button" type="primary">ÁªßÁª≠Êèê‰∫§</el-button>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, watch, getCurrentInstance, onMounted, reactive } from 'vue'
import {
  ElForm,
  ElFormItem,
  ElInput,
  ElRadioGroup,
  ElRadio,
  ElTable,
  ElTableColumn,
  ElButton,
  ElSelect,
  ElOption,
  ElDatePicker,
  ElMessage,
  ElLoading
} from 'element-plus'
import { message } from 'ant-design-vue'
import {
  getTimesByType,
  queryDeviceByMultiWord,
  wetlandSoilInsert,
  wetlandPlantInsert
} from '@/api/getData'
const loadingoptions = {
  // Âä†ËΩΩÈÖçÁΩÆ
  target: '.layoutLoading',
  background: 'rgba(0, 0, 0, 0.7)',
  text: 'Êï∞ÊçÆÂä†ËΩΩ‰∏≠...'
}

// Ë°®ÂçïÊï∞ÊçÆ
const soilFormRef = ref(null)

const soilForm = reactive({
  groups: [
    {
      key: Date.now(),
      depthRange: '',
      soilMoistureContent: '',
      soilOrganicMatterContent: '',
      totalSoilCarbonContent: '',
      totalSoilNitrogenContent: '',
      totalSoilPhosphorusContent: ''
    }
  ]
})
const addSoilGroup = () => {
  soilForm.groups.push({
    key: Date.now(),
    depthRange: '',
    soilMoistureContent: '',
    soilOrganicMatterContent: '',
    totalSoilCarbonContent: '',
    totalSoilNitrogenContent: '',
    totalSoilPhosphorusContent: ''
  })
}

const removeSoilGroup = (group) => {
  const index = soilForm.groups.indexOf(group)
  if (index !== -1) {
    soilForm.groups.splice(index, 1)
  }
}

const locations = ref([])
const userinfo = JSON.parse(localStorage.getItem('Userinfo'))
const current = ref(0)
const deviceName = ref('')
const investigationTime1 = ref('')
const submitType = ref('soil')
const infoVisible = ref(true)
const publisher = ref(userinfo.username)
const contactPhone = ref(userinfo.tel)
const contactAddress = ref(userinfo.address)
const contactEmail = ref(userinfo.email)
const productionUnit = ref(userinfo.productionCompany)

const publishStatus = ref('private')
const isRadioDisabled = ref(true)
const dataDescription = ref('')
const vegetationSpeciesOptions = ['Ëä¶Ëãá„ÄÅÁ¢éÁ±≥ËééËçâ']
const depthRange = ref('')
const soilMoistureContent = ref('')
const soilOrganicMatterContent = ref('')
const totalSoilCarbonContent = ref('')
const totalSoilNitrogenContent = ref('')
const totalSoilPhosphorusContent = ref('')
const leafAreaIndex = ref('')
const phenologicalIndex = ref('')
const vegetationMoistureContent = ref('')
const chlorophyllContent = ref('')
const biomass = ref('')
const carbonNitrogenRatio = ref('')
const vegetationSpecies = ref('')

const infoData = ref([
  { title: 'ÂèëÂ∏É‰∫∫', value: publisher.value },
  { title: 'ËÅîÁ≥ªÁîµËØù', value: contactPhone.value },
  { title: 'ËÅîÁ≥ªÂú∞ÂùÄ', value: contactAddress.value },
  { title: 'ËÅîÁ≥ªÈÇÆÁÆ±', value: contactEmail.value },
  { title: 'Âà∂‰ΩúÂçï‰Ωç', value: productionUnit.value }
])

const form = ref({
  deviceName: '',
  depthRange: '',
  soilMoistureContent: '',
  soilOrganicMatterContent: '',
  totalSoilCarbonContent: '',
  totalSoilNitrogenContent: '',
  totalSoilPhosphorusContent: '',
  leafAreaIndex: '',
  phenologicalIndex: '',
  vegetationMoistureContent: '',
  chlorophyllContent: '',
  biomass: '',
  carbonNitrogenRatio: '',
  vegetationSpecies: '',
  investigationTime1: '',
  dataDescription: '',
  publisher: '',
  contactPhone: '',
  contactAddress: '',
  contactEmail: '',
  productionUnit: '',
  publishStatus: 'private'
})

onMounted(() => {
  const instance = getCurrentInstance()
  if (instance) {
    instance.proxy.$nextTick(() => {
      // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
      const userinfo = JSON.parse(localStorage.getItem('Userinfo'))
      if (userinfo) {
        publisher.value = userinfo.username
        contactPhone.value = userinfo.tel
        contactAddress.value = userinfo.address
        contactEmail.value = userinfo.email
        productionUnit.value = userinfo.productionCompany
      }
      // Ê∏ÖÁ©∫ÂúüÂ£§ÁõëÊµãÁªÑÊï∞ÊçÆÂπ∂ÂàùÂßãÂåñ
      soilForm.groups = [
        {
          key: Date.now(),
          depthRange: '',
          soilMoistureContent: '',
          soilOrganicMatterContent: '',
          totalSoilCarbonContent: '',
          totalSoilNitrogenContent: '',
          totalSoilPhosphorusContent: ''
        }
      ]
      // Ëé∑ÂèñËÆæÂ§á‰ø°ÊÅØÂàóË°®
      getDeviceInfoList('05')
    })
  }
})

// Ê†πÊçÆËÆæÂ§áÁ±ªÂûãÔºåÊü•ËØ¢ËÆæÂ§áÂàóË°®
// ËßÇÊµãËÆæÂ§áÁßçÁ±ªÂàÜÁ±ªÔºõ
// 01ÔºöÂÖâË∞±ÂíåÊ∞¥‰ΩìÁõëÊµãÁÇπÔºõ
// 02ÔºöÂæÑÊµÅÁõëÊµãÁÇπÔºõ
// 03ÔºöÊ∞îË±°Á´ôÔºõ
// 04ÔºöÂ§ñ‰∏öË∞ÉÊü•ÁÇπ‰Ωç
// 05: ÊπøÂú∞ÁõëÊµãÁÇπ
function getDeviceInfoList(deviceType) {
  queryDeviceByMultiWord({
    id: '',
    deviceName: '',
    type: deviceType
  })
    .then((res) => {
      const result = res.response.value
      if (result.code === 'SUCCESS') {
        locations.value.push(...result.body)
        deviceName.value = locations.value[0].id
      } else {
        // Â§ÑÁêÜÂ§±Ë¥•ÁöÑÂìçÂ∫î
        ElMessage({
          showClose: true,
          message: result.msg,
          center: true
        })
      }
    })
    .catch((error) => {
      ElMessage({
        showClose: true,
        message: 'Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï',
        center: true,
        type: 'error'
      })
    })
}

watch(submitType, (newType) => {
  if (newType === 'soil') {
    // Ê∏ÖÁ©∫Ê§çË¢´Áõ∏ÂÖ≥Â≠óÊÆµ
    vegetationSpecies.value = ''
    leafAreaIndex.value = ''
    phenologicalIndex.value = ''
    vegetationMoistureContent.value = ''
    chlorophyllContent.value = ''
    biomass.value = ''
    carbonNitrogenRatio.value = ''
    // Ê∏ÖÁ©∫ÊâÄÊúâÂúüÂ£§ÁõëÊµãÁªÑÊï∞ÊçÆ
    if (soilForm.groups && soilForm.groups.length > 0) {
      soilForm.groups.forEach((group) => {
        group.depthRange = ''
        group.soilMoistureContent = ''
        group.soilOrganicMatterContent = ''
        group.totalSoilCarbonContent = ''
        group.totalSoilNitrogenContent = ''
        group.totalSoilPhosphorusContent = ''
      })
    }

    // ËÆæÁΩÆÈªòËÆ§Áä∂ÊÄÅ
    isRadioDisabled.value = true
    publishStatus.value = 'private'
  } else if (newType === 'plant') {
    // Ê∏ÖÁ©∫ÂúüÂ£§Áõ∏ÂÖ≥Â≠óÊÆµ
    if (soilForm.groups && soilForm.groups.length > 0) {
      soilForm.groups.forEach((group) => {
        group.depthRange = ''
        group.soilMoistureContent = ''
        group.soilOrganicMatterContent = ''
        group.totalSoilCarbonContent = ''
        group.totalSoilNitrogenContent = ''
        group.totalSoilPhosphorusContent = ''
      })
    }
    investigationTime1.value = ''

    // Ê∏ÖÁ©∫Ê§çË¢´Áõ∏ÂÖ≥Â≠óÊÆµ
    vegetationSpecies.value = ''
    leafAreaIndex.value = ''
    phenologicalIndex.value = ''
    vegetationMoistureContent.value = ''
    chlorophyllContent.value = ''
    biomass.value = ''
    carbonNitrogenRatio.value = ''

    // ËÆæÁΩÆÈªòËÆ§Áä∂ÊÄÅ
    isRadioDisabled.value = true
    publishStatus.value = 'private'
  }
})

function clearForm() {
  form.value = {
    deviceName: '',
    depthRange: '',
    soilMoistureContent: '',
    soilOrganicMatterContent: '',
    totalSoilCarbonContent: '',
    totalSoilNitrogenContent: '',
    totalSoilPhosphorusContent: '',
    leafAreaIndex: '',
    phenologicalIndex: '',
    vegetationMoistureContent: '',
    chlorophyllContent: '',
    biomass: '',
    carbonNitrogenRatio: '',
    vegetationSpecies: '',
    investigationTime1: '',
    dataDescription: '',
    publisher: '',
    contactPhone: '',
    contactAddress: '',
    contactEmail: '',
    productionUnit: '',
    publishStatus: ''
  }

  // Â¶ÇÊûúÊúâÂúüÂ£§ÁõëÊµãÁªÑÔºåÊ∏ÖÁ©∫ÊØè‰∏™ÁªÑÁöÑÊåáÊ†á
  if (soilForm.groups && soilForm.groups.length > 0) {
    soilForm.groups.forEach((group) => {
      group.depthRange = ''
      group.soilMoistureContent = ''
      group.soilOrganicMatterContent = ''
      group.totalSoilCarbonContent = ''
      group.totalSoilNitrogenContent = ''
      group.totalSoilPhosphorusContent = ''
    })
  }
}

function clearSoilForm() {
  if (soilForm.groups && soilForm.groups.length > 0) {
    soilForm.groups.forEach((group) => {
      group.depthRange = ''
      group.soilMoistureContent = ''
      group.soilOrganicMatterContent = ''
      group.totalSoilCarbonContent = ''
      group.totalSoilNitrogenContent = ''
      group.totalSoilPhosphorusContent = ''
    })
  }

  investigationTime1.value = ''
}

function clearVegetationForm() {
  leafAreaIndex.value = ''
  phenologicalIndex.value = ''
  vegetationMoistureContent.value = ''
  chlorophyllContent.value = ''
  biomass.value = ''
  carbonNitrogenRatio.value = ''
}

function handleCancel() {
  if (submitType.value === 'soil') {
    deviceName.value = ''
    investigationTime1.value = ''
    dataDescription.value = ''
    publisher.value = ''
    contactPhone.value = ''
    contactAddress.value = ''
    contactEmail.value = ''
    productionUnit.value = ''

    // ÈáçÁΩÆÊâÄÊúâÂúüÂ£§ÁõëÊµãÁªÑ
    if (soilForm.groups && soilForm.groups.length > 0) {
      soilForm.groups.forEach((group) => {
        group.depthRange = ''
        group.soilMoistureContent = ''
        group.soilOrganicMatterContent = ''
        group.totalSoilCarbonContent = ''
        group.totalSoilNitrogenContent = ''
        group.totalSoilPhosphorusContent = ''
      })
    }
  }

  if (submitType.value === 'plant') {
    clearVegetationForm()
    dataDescription.value = ''
    publisher.value = ''
    contactPhone.value = ''
    contactAddress.value = ''
    contactEmail.value = ''
    productionUnit.value = ''
  }
}

function handleSubmit() {
  if (!investigationTime1.value) {
    message.error('ËØ∑Â°´ÂÜôËßÇÊµãÊó•Êúü')
    return
  }
  if (submitType.value === 'soil') {
    // È™åËØÅÈÄªËæëÔºöÊ£ÄÊü• depthRange Ê†ºÂºè
    const rangeRegex = /^\d+-\d+$/ // ÂåπÈÖç "Êï∞Â≠ó-Êï∞Â≠ó" Ê†ºÂºè
    for (let i = 0; i < soilForm.groups.length; i++) {
      const group = soilForm.groups[i]
      const { depthRange, soilMoistureContent, soilOrganicMatterContent, totalSoilCarbonContent, totalSoilNitrogenContent, totalSoilPhosphorusContent} = group

      if (!depthRange) {
        message.error(`ËØ∑Â°´ÂÜôÁªÑ ${i + 1} ÁöÑÂúüÂ£§Ê∑±Â∫¶ËåÉÂõ¥`)
        return
      }

      if (!rangeRegex.test(depthRange)) {
        message.error(
          `ÁªÑ ${i + 1} ÁöÑÂúüÂ£§Ê∑±Â∫¶ËåÉÂõ¥Ê†ºÂºèÈîôËØØÔºåËØ∑ËæìÂÖ•Â¶Ç "0-20" ÁöÑÊ†ºÂºè`
        )
        return
      }

      const [start, end] = depthRange.split('-').map(Number)
      if (start >= end) {
        message.error(`ÁªÑ ${i + 1} ÁöÑÂúüÂ£§Ê∑±Â∫¶ËåÉÂõ¥Ëµ∑ÂßãÂÄºÂøÖÈ°ªÂ∞è‰∫éÁªìÊùüÂÄº`)
        return
      }

      if (!group.soilMoistureContent) {
        message.error(`ËØ∑Â°´ÂÜôÁªÑ ${i + 1} ÁöÑÂúüÂ£§Âê´Ê∞¥Èáè`)
        return
      }
      if (soilMoistureContent < 0 || soilMoistureContent > 100) {
        message.error(`ÁªÑ ${i + 1} ÁöÑÂúüÂ£§Âê´Ê∞¥ÈáèÂøÖÈ°ªÂú®0Âà∞100‰πãÈó¥`)
        return
      }

      if (!group.soilOrganicMatterContent) {
        message.error(`ËØ∑Â°´ÂÜôÁªÑ ${i + 1} ÁöÑÂúüÂ£§ÊúâÊú∫Áâ©Âê´Èáè`)
        return
      }
      if (soilOrganicMatterContent < 0 ) {
        message.error(`ÁªÑ ${i + 1} ÁöÑÂúüÂ£§ÊúâÊú∫Áâ©Âê´Èáè‰∏çËÉΩ‰∏∫Ë¥üÊï∞`)
        return
      }

      if (!group.totalSoilCarbonContent) {
        message.error(`ËØ∑Â°´ÂÜôÁªÑ ${i + 1} ÁöÑÂúüÂ£§Âê´Á¢≥ÊÄªÈáè`)
        return
      }
      if (totalSoilCarbonContent < 0 ) {
        message.error(`ÁªÑ ${i + 1} ÁöÑÂúüÂ£§Âê´Á¢≥ÊÄªÈáè‰∏çËÉΩ‰∏∫Ë¥üÊï∞`)
        return
      }

      if (!group.totalSoilNitrogenContent) {
        message.error(`ËØ∑Â°´ÂÜôÁªÑ ${i + 1} ÁöÑÂúüÂ£§Âê´Ê∞ÆÊÄªÈáè`)
        return
      }
      if (totalSoilNitrogenContent < 0 ) {
        message.error(`ÁªÑ ${i + 1} ÁöÑÂúüÂ£§Âê´Ê∞ÆÊÄªÈáè‰∏çËÉΩ‰∏∫Ë¥üÊï∞`)
        return
      }

      if (!group.totalSoilPhosphorusContent) {
        message.error(`ËØ∑Â°´ÂÜôÁªÑ ${i + 1} ÁöÑÂúüÂ£§Âê´Á£∑ÊÄªÈáè`)
        return
      }
      if (totalSoilPhosphorusContent < 0 ) {
        message.error(`ÁªÑ ${i + 1} ÁöÑÂúüÂ£§Âê´Á£∑ÊÄªÈáè‰∏çËÉΩ‰∏∫Ë¥üÊï∞`)
        return
      }
  }
}
if (submitType.value === 'plant') {
    if (!vegetationSpecies.value) {
      message.error('ËØ∑Â°´ÂÜôÊ§çË¢´Áâ©Áßç')
      return
    }
    if (!leafAreaIndex.value) {
      message.error('ËØ∑Â°´ÂÜôÂè∂Èù¢ÁßØÊåáÊï∞')
      return
    }
    if (!phenologicalIndex.value) {
      message.error('ËØ∑Â°´ÂÜôÁâ©ÂÄôÊåáÊï∞')
      return
    }
    if (!vegetationMoistureContent.value) {
      message.error('ËØ∑Â°´ÂÜôÊ§çË¢´Âê´Ê∞¥Èáè')
      return
    }
    if (vegetationMoistureContent.value < 0 || vegetationMoistureContent.value > 100) {
        message.error('Ê§çË¢´Âê´Ê∞¥ÈáèÂê´Ê∞¥ÈáèÂøÖÈ°ªÂú®0Âà∞100‰πãÈó¥')
        return
      }
    if (!chlorophyllContent.value) {
      message.error('ËØ∑Â°´ÂÜôÂè∂ÁªøÁ¥†Âê´Èáè')
      return
    }
    if (chlorophyllContent.value < 0 ) {
        message.error('Âè∂ÁªøÁ¥†Âê´Èáè‰∏çËÉΩ‰∏∫Ë¥üÊï∞')
        return
      }
    if (!biomass.value) {
      message.error('ËØ∑Â°´ÂÜôÁîüÁâ©Èáè')
      return
    }
    if (biomass.value < 0 ) {
        message.error('ÁîüÁâ©Èáè‰∏çËÉΩ‰∏∫Ë¥üÊï∞')
        return
      }
    if (!carbonNitrogenRatio.value) {
      message.error('ËØ∑Â°´ÂÜôÁ¢≥Ê∞ÆÊØî')
      return
    }
    if (carbonNitrogenRatio.value < 0 ) {
        message.error('Á¢≥Ê∞ÆÊØî‰∏çËÉΩ‰∏∫Ë¥üÊï∞')
        return
      }
    }
  infoData.value = [
    { title: 'ÂèëÂ∏É‰∫∫', value: publisher.value },
    { title: 'ËÅîÁ≥ªÁîµËØù', value: contactPhone.value },
    { title: 'ËÅîÁ≥ªÂú∞ÂùÄ', value: contactAddress.value },
    { title: 'ËÅîÁ≥ªÈÇÆÁÆ±', value: contactEmail.value },
    { title: 'Âà∂‰ΩúÂçï‰Ωç', value: productionUnit.value }
  ]
  current.value = 1
}

function handlePrevious() {
  if (current.value > 0) {
    current.value -= 1
  }
}

function handleConfirm() {
  if (submitType.value === 'soil') {
    const loadingInstance = ElLoading.service(loadingoptions)
    // È™åËØÅÈÄöËøáÔºåÂ§ÑÁêÜÊèê‰∫§Êï∞ÊçÆ
    const soilData = soilForm.groups.map((group) => ({
      deviceId: deviceName.value,
      depthRange: group.depthRange,
      soilMoistureContent: group.soilMoistureContent,
      soilOrganicMatterContent: group.soilOrganicMatterContent,
      totalSoilCarbonContent: group.totalSoilCarbonContent,
      totalSoilNitrogenContent: group.totalSoilNitrogenContent,
      totalSoilPhosphorusContent: group.totalSoilPhosphorusContent,
      investigationTime: investigationTime1.value,
      userName: publisher.value,
      contactPhone: contactPhone.value,
      contactAddress: contactAddress.value,
      createUserid: userinfo.id,
      productionUnit: productionUnit.value,
      dataIntroduction: dataDescription.value,
      contactEmail: contactEmail.value,
      open: publishStatus.value === 'public' ? 1 : 0
    }))

    wetlandSoilInsert(soilData)
      .then((res) => {
        loadingInstance.close()
        const response = res.response.value
        if (response.code === 'SUCCESS') {
          message.success('Ë°®ÂçïÊèê‰∫§ÊàêÂäü.')
          current.value = 2
        } else {
          message.error('Ë°®ÂçïÊèê‰∫§Â§±Ë¥•.')
        }
      })
      .catch((error) => {
        loadingInstance.close()
        console.error('ËØ∑Ê±ÇÂ§±Ë¥•:', error)
        message.error('ËØ∑Ê±ÇÂ§±Ë¥•: ' + error.message)
      })
    }
  

    if (submitType.value === 'plant') {
      const loadingInstance = ElLoading.service(loadingoptions)
      const data2 = {
      deviceId: deviceName.value,
      leafAreaIndex: leafAreaIndex.value,
      phenologicalIndex: phenologicalIndex.value,
      vegetationMoistureContent: vegetationMoistureContent.value,
      chlorophyllContent: chlorophyllContent.value,
      biomass: biomass.value,
      carbonNitrogenRatio: carbonNitrogenRatio.value,
      vegetationSpecies: vegetationSpecies.value,
      investigationTime: investigationTime1.value,
      userName: publisher.value,
      contactPhone: contactPhone.value,
      contactAddress: contactAddress.value,
      createUserid: userinfo.id,
      productionUnit: productionUnit.value,
      dataIntroduction: dataDescription.value,
      contactEmail: contactEmail.value,
      open: publishStatus.value === 'public' ? 1 : 0
    }
    wetlandPlantInsert([data2])
      .then((res) => {
        loadingInstance.close()
        const response = res.response.value
        if (response.code === 'SUCCESS') {
          message.success('Ë°®ÂçïÊèê‰∫§ÊàêÂäü.')
          current.value = 2
        } else {
          message.error('Ë°®ÂçïÊèê‰∫§Â§±Ë¥•.')
        }
      })
      .catch((error) => {
        loadingInstance.close()
        console.error('ËØ∑Ê±ÇÂ§±Ë¥•:', error)
        message.error('ËØ∑Ê±ÇÂ§±Ë¥•: ' + error.message)
      })
    }
  }


function handleContinue() {
  clearForm()
  current.value = 0
}
function hideInfo() {
  infoVisible.value = false
}
</script>

<style scoped>
.steps-container {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 30px;
  min-height: 30px;
}

.steps-container .ant-steps {
  max-width: 70%;
  width: 70%;
}

.info-box {
  width: 33%;
  background-color: #e6f7ff;
  color: #1890ff;
  border: 1px solid #91d5ff;
  border-radius: 4px;
  padding: 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin: 20px auto;
}

.icon {
  margin-right: 10px;
  font-size: 20px;
}

.close-button:hover {
  color: red;
}

.form-container {
  padding: 30px;
  max-width: 1200px;
  margin: 0 auto;
}

.steps-container {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 30px;
  min-height: 30px;
}

.steps-container .ant-steps {
  max-width: 70%;
  width: 70%;
}

.button-group {
  display: flex;
  justify-content: center;
  margin-top: 20px;
}

.cancel-button,
.submit-button {
  padding: 10px 15px;
  border: 1px solid #d9d9d9;
  background-color: #f0f0f0;
  color: #000;
  border-radius: 4px;
  margin: 0 10px;
  transition: background-color 0.3s, color 0.3s;
}

.cancel-button:hover,
.submit-button:hover {
  background-color: #1890ff;
  color: white;
  cursor: pointer;
}

.completion-icon {
  width: 100px;
  height: 100px;
  background: rgba(116, 192, 65, 1);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 20px auto;
}

.completion-icon::before {
  content: '‚úî';
  color: white;
  font-size: 50px;
}
</style>
