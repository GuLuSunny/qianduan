<template>
  <div>
    <!-- ËøõÂ∫¶Ê†è -->
    <div class="steps-container">
      <a-steps :current="current">
        <a-step title="Â°´ÂÜôËµÑÊñô‰ø°ÊÅØ" />
        <a-step title="Á°ÆËÆ§ËµÑÊñô‰ø°ÊÅØ" />
        <a-step title="ÂÆåÊàê" />
      </a-steps>
    </div>

    <!-- ÊèêÁ§∫Ê°Ü -->
    <div class="info-box" v-if="infoVisible">
      <span class="icon">üîî</span>
      ËµÑÊñô‰∏ä‰º†ÊàêÂäüÂêéÂèØÂú®Êï∞ÊçÆÊü•ËØ¢È°µÈù¢Êü•Áúã
      <el-button class="close-button" @click="hideInfo" type="text"
        >√ó</el-button
      >
    </div>

    <!-- Ë°®ÂçïÂÜÖÂÆπ -->
    <div class="form-container">
      <!-- È∏üÁ±ª‰ø°ÊÅØÊ®™ÂêëÊéíÂàóÂÆπÂô® -->
      <el-form :model="form" label-width="140px" v-if="current === 0">
        <div class="form-horizontal-group">
          <!-- Á¨¨‰∏ÄÂàó -->
          <div class="form-column">
            <el-form-item label="ÊâÄÂ±ûÁõÆÂêç" :required = "true">
              <el-select v-model="birdorderId" placeholder="ËØ∑ÈÄâÊã©Ê∞¥È∏üÊâÄÂ±ûÁõÆÂêç">
                <el-option
                  v-for="order in birdOrders"
                  :key="order.id"
                  :label="order.name"
                  :value="order.id"
                ></el-option>
              </el-select>
            </el-form-item>
            <el-form-item label="ÊâÄÂ±ûÁßëÂêç" :required = "true">
              <el-select
                v-model="birdfamilyId"
                placeholder="ËØ∑ÈÄâÊã©Ê∞¥È∏üÊâÄÂ±ûÁßëÂêç"
              >
                <el-option
                  v-for="family in filteredFamilies"
                  :key="family.id"
                  :label="family.name"
                  :value="family.id"
                ></el-option>
              </el-select>
            </el-form-item>
            <el-form-item label="Ê∞¥È∏üÁßçÁ±ª" :required = "true">
              <el-select v-model="birdSpeciesId" placeholder="ËØ∑ÈÄâÊã©Ê∞¥È∏üÁßçÁ±ª">
                <el-option
                  v-for="species in filteredSpecies"
                  :key="species.id"
                  :label="species.name"
                  :value="species.id"
                ></el-option>
              </el-select>
            </el-form-item>
            <el-form-item label="Ê∞¥È∏üÊï∞Èáè" :required = "true">
              <el-input-number
                v-model="birdCount"
                placeholder="ËØ∑ËæìÂÖ•Ê∞¥È∏üÊï∞Èáè"
                min="1"
                :precision="0"
                style="width: 100%;"
                controls-position="right"
              ></el-input-number>
            </el-form-item>
            <el-form-item label="ËßÇÊµãÊó•Êúü" :required = "true">
              <el-date-picker
                v-model="observationDate"
                type="date"
                format="YYYY-MM-DD"
                value-format="YYYY-MM-DD"
                placeholder="ËØ∑ÈÄâÊã©ËßÇÊµãÊó•Êúü"
              />
            </el-form-item>
          </div>
          <!-- Á¨¨‰∫åÂàó -->
          <div class="form-column">
            <el-form-item label="Â§©Ê∞î" :required = "true">
              <el-input
                v-model="weather"
                placeholder="ËØ∑ËæìÂÖ•Â§©Ê∞îÁä∂ÂÜµ"
              ></el-input>
            </el-form-item>
            <el-form-item label="ËßÇÂØüÂú∞ÁÇπ" :required = "true">
              <el-select v-model="observingsites" placeholder="ËØ∑ÈÄâÊã©ËßÇÂØüÂú∞ÁÇπ">
                <el-option
                  v-for="site in locations"
                  :key="site"
                  :label="site"
                  :value="site"
                ></el-option>
              </el-select>
            </el-form-item>
            <el-form-item label="ÁîüÂ¢ÉÁ±ªÂûã" :required = "true">
              <el-select v-model="habitattype" placeholder="ËØ∑ÈÄâÊã©ÁîüÂ¢ÉÁ±ªÂûã">
                <el-option
                  v-for="type in habitatTypes"
                  :key="type"
                  :label="type"
                  :value="type"
                ></el-option>
              </el-select>
            </el-form-item>
            <el-form-item label="ËßÇÂØü‰∫∫ÂëòÊâÄÂ±ûÁªÑÂà´" :required = "true">
              <el-select
                v-model="personnelgroup"
                placeholder="ËØ∑ÈÄâÊã©‰∫∫ÂëòÊâÄÂ±ûÁªÑÂà´"
              >
                <el-option
                  v-for="group in groups"
                  :key="group.id"
                  :label="group.name"
                  :value="group.id"
                ></el-option>
              </el-select>
            </el-form-item>
            <el-form-item label="ËßÇÊµãÊó∂Èó¥" :required = "true">
              <el-time-picker
                v-model="observationTimeRange"
                is-range
                range-separator="Ëá≥"
                start-placeholder="ÂºÄÂßãÊó∂Èó¥"
                end-placeholder="ÁªìÊùüÊó∂Èó¥"
                format="HH:mm:ss"
                value-format="HH:mm:ss"
                :clearable="false"
              />
            </el-form-item>
          </div>
        </div>
      </el-form>
      <!-- ÊåâÈíÆ -->
      <div class="button-group" v-if="current === 0">
        <el-button @click="handleCancel" class="cancel-button">ÂèñÊ∂à</el-button>
        <el-button @click="handleSubmit" class="submit-button" type="primary"
          >Êèê‰∫§</el-button
        >
      </div>
    </div>
    <!-- Á°ÆËÆ§ËµÑÊñô‰ø°ÊÅØÈÉ®ÂàÜ -->
    <div class="form-container" v-if="current === 1">
      <el-table
        :data="infoData"
        style="width: 50%; margin: 0 auto"
        border
        :header-cell-style="{ backgroundColor: '#f2f2f2' }"
      >
        <el-table-column
          prop="title"
          label="‰ø°ÊÅØÈ°π"
          width="150"
        ></el-table-column>
        <el-table-column prop="value" label="ÂÜÖÂÆπ"></el-table-column>
      </el-table>
      <div class="button-group">
        <el-button @click="handlePrevious" class="cancel-button"
          >‰∏ä‰∏ÄÊ≠•</el-button
        >
        <el-button @click="handleConfirm" class="submit-button" type="primary"
          >Á°ÆËÆ§</el-button
        >
      </div>
    </div>

    <!-- ‰∏ä‰º†ÂÆåÊàêÈ°µÈù¢ -->
    <div class="form-container" v-if="current === 2">
      <div class="completion-icon"></div>
      <h1 class="form-title">‰∏ä‰º†ÂÆåÊàê</h1>
      <div class="button-group">
        <el-button @click="handleContinue" class="submit-button" type="primary"
          >ÁªßÁª≠Êèê‰∫§</el-button
        >
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch, onMounted } from 'vue'
import { message } from 'ant-design-vue'
import {
  getBirdData,
  queryDeviceByMultiWord,
  observationBirdInsert
} from '@/api/getData'
import { ElMessage, ElLoading } from 'element-plus'

const birdOrders = ref([])
const birdFamilies = ref({})
const birdSpeciesMap = ref({})
const groups = ref([])

const birdSpeciesId = ref('') // È∏üÁ±ªÁßçÁ±ª
const birdfamilyId = ref('') // È∏üÁ±ªÁßëÂêç
const birdorderId = ref('') // È∏üÁ±ªÁõÆÂêç
const birdCount = ref('') // È∏üÁ±ªÊï∞Èáè
const observationTimeRange = ref(['', '']) // ËßÇÂØüÊó∂ÊÆµ
const habitattype = ref('') // ÁîüÂ¢ÉÁ±ªÂûã
const weather = ref('') // Â§©Ê∞î
const observingsites = ref('') // ËßÇÂØüÂú∞ÁÇπ
const personnelgroup = ref('') // ËßÇÂØü‰∫∫ÂëòÊâÄÂ±ûÁªÑÂà´
const current = ref(0) // ÂΩìÂâçÊ≠•È™§
const infoVisible = ref(true) // ÊèêÁ§∫Ê°ÜÊòØÂê¶ÂèØËßÅ
const observationDate = ref('') // ËßÇÊµãÊó•Êúü
const loadingoptions = {
  // Âä†ËΩΩÈÖçÁΩÆ
  target: '.layoutLoading',
  background: 'rgba(0, 0, 0, 0.7)',
  text: 'Êï∞ÊçÆÂä†ËΩΩ‰∏≠...'
}
const infoData = ref([
  {
    title: 'ÊâÄÂ±ûÁõÆÂêç',
    value: computed(
      () =>
        birdOrders.value.find((order) => order.id === birdorderId.value)
          ?.name || ''
    )
  },
  {
    title: 'ÊâÄÂ±ûÁßëÂêç',
    value: computed(() => {
      const selectedOrder = birdOrders.value.find(
        (order) => order.id === birdorderId.value
      )
      return (
        birdFamilies.value[selectedOrder ? selectedOrder.name : '']?.find(
          (family) => family.id === birdfamilyId.value
        )?.name || ''
      )
    })
  },
  {
    title: 'Ê∞¥È∏üÁßçÁ±ª',
    value: computed(() => {
      const selectedFamily = Object.values(birdFamilies.value)
        .flat()
        .find((family) => family.id === birdfamilyId.value)
      return (
        birdSpeciesMap.value[selectedFamily ? selectedFamily.name : '']?.find(
          (species) => species.id === birdSpeciesId.value
        )?.name || ''
      )
    })
  },
  { title: 'Ê∞¥È∏üÊï∞Èáè', value: birdCount },
  {
    title: 'ËßÇÊµãÊó∂ÊÆµ',
    value: observationTimeRange.value[0] + ' - ' + observationTimeRange.value[1]
  },
  { title: 'ËßÇÂØüÂú∞ÁÇπ', value: observingsites },
  { title: 'Â§©Ê∞î', value: weather },
  { title: 'ÁîüÂ¢ÉÁ±ªÂûã', value: habitattype },
  {
    title: 'ËßÇÂØü‰∫∫ÂëòÊâÄÂ±ûÁªÑÂà´',
    value: computed(
      () =>
        groups.value.find((group) => group.id === personnelgroup.value)?.name ||
        ''
    )
  }
])

const habitatTypes = [
  'Ê∞¥‰∏≠„ÄÅÁ©∫‰∏≠È£ûËøá',
  'Ê∞¥‰∏≠„ÄÅÁ©∫‰∏≠È£ûËøá„ÄÅÂ≤∏‰∏ä',
  'Êª©Ê∂Ç',
  'Ê∞¥‰∏≠',
  'Á©∫‰∏≠È£ûËøá„ÄÅÂ≤∏‰∏ä',
  'Ê∞¥‰∏≠„ÄÅÁ©∫‰∏≠È£ûËøá„ÄÅÂÖ∂‰ªñ',
  'Â≤∏‰∏ä',
  'Á©∫‰∏≠È£ûËøá',
  'Êª©Ê∂Ç„ÄÅÁ©∫‰∏≠È£ûËøá',
  'Ê†ë‰∏ä',
  'Êª©Ê∂Ç„ÄÅÁ©∫‰∏≠È£ûËøá„ÄÅÂÖ∂‰ªñ',
  'Ê∞¥‰∏≠„ÄÅÂ≤∏‰∏ä',
  'ÂÖ∂‰ªñ',
  'Êó†'
]

const locations = ref([])

// È™åËØÅË°®ÂçïÊòØÂê¶ÊúâÊïà
const isFormValid = computed(() => {
  return (
    birdorderId.value &&
    birdfamilyId.value &&
    birdSpeciesId.value &&
    birdCount.value &&
    observationTimeRange.value[0] &&
    observationTimeRange.value[1] &&
    weather.value &&
    observingsites.value &&
    habitattype.value &&
    personnelgroup.value
  )
})

// Ê†πÊçÆÊâÄÈÄâÁõÆÂêçËøáÊª§ÁöÑÁßëÁõÆ
const filteredFamilies = computed(() => {
  const selectedOrder = birdOrders.value.find(
    (order) => order.id === birdorderId.value
  )
  return birdFamilies.value[selectedOrder ? selectedOrder.name : ''] || []
})
// Ê†πÊçÆÊâÄÈÄâÁßëÁõÆËøáÊª§ÁöÑÁßçÁ±ª
const filteredSpecies = computed(() => {
  const selectedFamily = Object.values(birdFamilies.value)
    .flat()
    .find((family) => family.id === birdfamilyId.value)
  return birdSpeciesMap.value[selectedFamily ? selectedFamily.name : ''] || []
})

// ÁõëÂê¨ birdordername ÁöÑÂèòÂåñ
watch(birdorderId, (newOrderName) => {
  if (filteredFamilies.value.length > 0) {
    birdfamilyId.value = filteredFamilies.value[0].id
  } else {
    birdfamilyId.value = ''
  }
  // ÂΩìÁõÆÂêçÂèòÂåñÊó∂ÔºåÁßçÁ±ª‰πüÈúÄË¶ÅÁõ∏Â∫îÂèòÂåñ
  if (filteredSpecies.value.length > 0) {
    birdSpeciesId.value = filteredSpecies.value[0].id
  } else {
    birdSpeciesId.value = ''
  }
})

// ÁõëÂê¨ birdfamilyname ÁöÑÂèòÂåñ
watch(birdfamilyId, (newFamilyName) => {
  if (filteredSpecies.value.length > 0) {
    birdSpeciesId.value = filteredSpecies.value[0].id
  } else {
    birdSpeciesId.value = ''
  }
})

watch(
  () => observationTimeRange.value,
  (newTimeRange) => {
    infoData.value[4].value = newTimeRange[0] + ' Ëá≥ ' + newTimeRange[1]
  }
)

function handleCancel () {
  birdorderId.value =
    birdfamilyId.value =
    birdSpeciesId.value =
    birdCount.value =
    observationTimeRange.value =
    weather.value =
    observingsites.value =
    habitattype.value =
    personnelgroup.value =
    observationDate.value =
      ''
}

function handleSubmit () {
  if (!isFormValid.value) {
    message.error('ËØ∑Â°´ÂÜôÂÆåÊï¥Ë°®Âçï‰ø°ÊÅØ')
    return
  }
  birdCount.value = parseInt(birdCount.value)
  current.value = 1 // ËøõÂÖ•Á°ÆËÆ§ËµÑÊñô‰ø°ÊÅØÊ≠•È™§
}

function handlePrevious () {
  if (current.value > 0) {
    current.value -= 1
  }
}

function handleConfirm () {
  const loadingInstance = ElLoading.service(loadingoptions)
  const data = {
    orderId: birdorderId.value,
    familyId: birdfamilyId.value,
    speciesId: birdSpeciesId.value,
    watchPiId: personnelgroup.value,
    observationPeriodBegin: observationTimeRange.value[0],
    observationPeriodEnd: observationTimeRange.value[1],
    observationAddress: observingsites.value,
    habitatType: habitattype.value,
    number: birdCount.value,
    weather: weather.value,
    observationTime: observationDate.value
  }

  observationBirdInsert(data)
    .then((res) => {
      loadingInstance.close()
      const result = res.response.value
      if (result.code === 'SUCCESS') {
        message.success('Ë°®ÂçïÊèê‰∫§ÊàêÂäü.')
        current.value = 2
      } else {
        message.error('Ë°®ÂçïÊèê‰∫§Â§±Ë¥•: ' + result.message)
      }
    })
    .catch((error) => {
      loadingInstance.close()
      console.error('ËØ∑Ê±ÇÂ§±Ë¥•:', error)
      message.error('ËØ∑Ê±ÇÂ§±Ë¥•: ' + error.message)
    })
}

function handleContinue () {
  handleCancel() // ÈáçÁΩÆË°®Âçï
  current.value = 0 // ËøîÂõûÂ°´ÂÜôËµÑÊñô‰ø°ÊÅØÊ≠•È™§
}
function hideInfo () {
  infoVisible.value = false
}

// Ëé∑ÂèñÁõÆ„ÄÅÁßë„ÄÅÁßçÁ±ª„ÄÅÁªÑÂà´Êï∞ÊçÆ
function getBirdDataFunc () {
  getBirdData()
    .then((res) => {
      const response = res.response.value
      if (response.code === 'SUCCESS') {
        const body = response.body
        birdOrders.value = body.orders.map((order) => ({
          id: order.id,
          name: order.name
        }))
        body.familyToorder.forEach((item) => {
          if (!birdFamilies.value[item.orderName]) {
            birdFamilies.value[item.orderName] = []
          }
          item.familyId.forEach((id, index) => {
            birdFamilies.value[item.orderName].push({
              id,
              name: item.familyName[index]
            })
          })
        })
        body.speciesTofamily.forEach((item) => {
          if (!birdSpeciesMap.value[item.familyName]) {
            birdSpeciesMap.value[item.familyName] = []
          }
          item.speciesId.forEach((id, index) => {
            birdSpeciesMap.value[item.familyName].push({
              id,
              name: item.speciesName[index]
            })
          })
        })
        groups.value = body.groups[0].groupId.map((id, index) => ({
          id,
          name: body.groups[0].groupName[index]
        }))
      } else {
        message.error('Ëé∑ÂèñÊ∞¥È∏üÊï∞ÊçÆÂ§±Ë¥•: ' + response.msg)
      }
    })
    .catch((error) => {
      console.error('ËØ∑Ê±ÇÂ§±Ë¥•:', error)
      message.error('ËØ∑Ê±ÇÂ§±Ë¥•: ' + error.message)
    })
}

function fetchDeviceOptions () {
  queryDeviceByMultiWord({ type: '09' })
    .then((res) => {
      if (res.response.value.code === 'SUCCESS') {
        locations.value = res.response.value.body.map((item) => item.deviceName)
      } else {
        ElMessage.error(res.response.value.msg)
      }
    })
    .catch(() => {
      ElMessage.error('Ëé∑ÂèñËÆæÂ§áÊï∞ÊçÆÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï')
    })
}

// Ëé∑ÂèñÈ∏üÁ±ªÊï∞ÊçÆ
onMounted(() => {
  fetchDeviceOptions()
  getBirdDataFunc()
})
</script>

<style scoped>
.form-container {
  margin: 20px auto;
  max-width: 1200px;
  /* ËÆæÁΩÆË°®ÂçïÊúÄÂ§ßÂÆΩÂ∫¶ */
}

.form-horizontal-group {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  /* Ê∞¥Âπ≥Â±Ö‰∏≠ */
}

.form-column {
  flex: 1;
  padding: 0 20px;
  /* ÂèØÈÄâÔºö‰∏∫ÂàóÊ∑ªÂä†ÂÜÖËæπË∑ù */
}

.el-form-item {
  width: 100%;
  margin-bottom: 50px;
  /* Â¢ûÂä†‰∏ãÊñπÈó¥Ë∑ù */
}

.form-title {
  font-size: 24px;
  margin-bottom: 20px;
}

.form-group {
  display: flex;
  flex-wrap: wrap;
  /* ÂÖÅËÆ∏Êç¢Ë°åÔºå‰ΩÜÂú®Ëøô‰∏™Âú∫ÊôØ‰∏ãÂèØËÉΩ‰∏çÈúÄË¶Å */
  align-items: center;
  /* ÂûÇÁõ¥Â±Ö‰∏≠ */
  margin-bottom: 30px;
  /* Â¢ûÂä†Â∫ïÈÉ®Èó¥Ë∑ùÔºåË∞ÉÊï¥Ê°Ü‰∏éÊ°Ü‰πãÈó¥ÁöÑÂûÇÁõ¥Ë∑ùÁ¶ª */
  margin-left: 120px;
}

.form-horizontal-group {
  display: flex;
  flex-wrap: wrap;
  /* ÂÖÅËÆ∏Êç¢Ë°å */
  margin-top: 20px;
}

.steps-container {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 30px;
  min-height: 30px;
}

.steps-container .ant-steps {
  max-width: 70%;
  width: 70%;
}

.info-box {
  width: 33%;
  background-color: #e6f7ff;
  color: #1890ff;
  border: 1px solid #91d5ff;
  border-radius: 4px;
  padding: 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin: 20px auto;
}

.icon {
  margin-right: 10px;
  font-size: 20px;
}

.close-button {
  background: none;
  border: none;
  color: #1890ff;
  font-size: 20px;
  cursor: pointer;
}

.close-button:hover {
  color: red;
}

.button-group {
  display: flex;
  justify-content: center;
  margin-top: 20px;
}

.cancel-button,
.submit-button {
  padding: 10px 15px;
  border: 1px solid #d9d9d9;
  background-color: #f0f0f0;
  color: #000;
  border-radius: 4px;
  margin: 0 10px;
  transition: background-color 0.3s, color 0.3s;
}

.cancel-button:hover,
.submit-button:hover {
  background-color: #1890ff;
  color: white;
  cursor: pointer;
}

.ta {
  text-align: left;
  font-size: 14px;
  text-indent: 120px;
  /* Á¨¨‰∏ÄË°åÂêëÂè≥Áº©ËøõÔºåÂÄºÂèØ‰ª•Ê†πÊçÆÈúÄË¶ÅË∞ÉÊï¥ */
}

select {
  height: 30px;
  /* ËÆæÁΩÆ select ÂÖÉÁ¥†ÁöÑÈ´òÂ∫¶ */
  padding: 5px;
  /* ËÆæÁΩÆÂÜÖËæπË∑ùÔºåÊ†πÊçÆÈúÄË¶ÅË∞ÉÊï¥ */
  font-size: 12px;
  /* ÂèØÈÄâÔºåËÆæÁΩÆÂ≠ó‰ΩìÂ§ßÂ∞è */
}

option {
  line-height: 20px;
  /* Á°Æ‰øù option ÂÖÉÁ¥†ÁöÑÊñáÂ≠ó‰πüÂ±Ö‰∏≠ */
}

.completion-icon {
  width: 100px;
  height: 100px;
  background: rgba(116, 192, 65, 1);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 20px auto;
}

.completion-icon::before {
  content: '‚úî';
  color: white;
  font-size: 50px;
}
</style>
